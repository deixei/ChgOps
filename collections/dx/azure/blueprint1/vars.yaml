azure:
  tags: &tags
    Owner: rust@deixei.com
    TechOwner: rust@deixei.com
    Ecosystem: ECOSYSTEM-NAME
    Department: MY-DEPARTMENT-CODE
    OperationalContact: rust@deixei.com
    CostCenter: '1111111111'
  blueprint:
    blueprint1: &azure_blueprint_blueprint1
      description: Web app with private endpoint
      parameters:
        "$schema": https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#
        contentVersion: 1.0.0.0
        parameters:
          sites_name:
            value: "{{ self.sites_name }}"
          serverfarms_asp_externalid:
            value: "{{ self.serverfarms_asp_externalid }}"


      template:
        "$schema": https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#
        contentVersion: 1.0.0.0
        parameters:
          sites_name:
            defaultValue: "{{ self.sites_name }}"
            type: String
          serverfarms_asp_externalid:
            defaultValue: "/subscriptions/{{ self.subscription }}/resourceGroups/{{ self.resourceGroup }}/providers/Microsoft.Web/serverfarms/{{ self.sites_name }}-asp"
            type: String
        variables: {}
        resources:
        - type: Microsoft.Web/sites
          apiVersion: '2023-12-01'
          name: "[parameters('sites_name')]"
          location: West Europe
          tags: *tags
          kind: app,linux
          properties:
            enabled: true
            hostNameSslStates:
            - name: "[concat(parameters('sites_name'), '.azurewebsites.net')]"
              sslState: Disabled
              hostType: Standard
            - name: "[concat(parameters('sites_name'), '.scm.azurewebsites.net')]"
              sslState: Disabled
              hostType: Repository
            serverFarmId: "[parameters('serverfarms_asp_externalid')]"
            reserved: true
            isXenon: false
            hyperV: false
            dnsConfiguration: {}
            vnetRouteAllEnabled: false
            vnetImagePullEnabled: false
            vnetContentShareEnabled: false
            siteConfig:
              numberOfWorkers: 1
              linuxFxVersion: PYTHON|3.10
              acrUseManagedIdentityCreds: false
              alwaysOn: true
              http20Enabled: true
              functionAppScaleLimit: 0
              minimumElasticInstanceCount: 0
            scmSiteAlsoStopped: false
            clientAffinityEnabled: false
            clientCertEnabled: true
            clientCertMode: Required
            hostNamesDisabled: false
            vnetBackupRestoreEnabled: false
            customDomainVerificationId: EE9C79222FD74ACDF009ED42F10A214A816706A4DD0325CEFFB2D87BBA9D6EED
            containerSize: 0
            dailyMemoryTimeQuota: 0
            httpsOnly: false
            redundancyMode: None
            publicNetworkAccess: Disabled
            storageAccountRequired: false
            keyVaultReferenceIdentity: SystemAssigned
        - type: Microsoft.Web/sites/basicPublishingCredentialsPolicies
          apiVersion: '2023-12-01'
          name: "[concat(parameters('sites_name'), '/ftp')]"
          location: West Europe
          dependsOn:
          - "[resourceId('Microsoft.Web/sites', parameters('sites_name'))]"
          tags: *tags
          properties:
            allow: true
        - type: Microsoft.Web/sites/basicPublishingCredentialsPolicies
          apiVersion: '2023-12-01'
          name: "[concat(parameters('sites_name'), '/scm')]"
          location: West Europe
          dependsOn:
          - "[resourceId('Microsoft.Web/sites', parameters('sites_name'))]"
          tags: *tags
          properties:
            allow: true
        - type: Microsoft.Web/sites/config
          apiVersion: '2023-12-01'
          name: "[concat(parameters('sites_name'), '/web')]"
          location: West Europe
          dependsOn:
          - "[resourceId('Microsoft.Web/sites', parameters('sites_name'))]"
          tags: *tags
          properties:
            numberOfWorkers: 1
            defaultDocuments:
            - Default.htm
            - Default.html
            - Default.asp
            - index.htm
            - index.html
            - iisstart.htm
            - default.aspx
            - index.php
            - hostingstart.html
            netFrameworkVersion: v4.0
            linuxFxVersion: PYTHON|3.10
            requestTracingEnabled: false
            remoteDebuggingEnabled: false
            remoteDebuggingVersion: VS2019
            httpLoggingEnabled: false
            acrUseManagedIdentityCreds: false
            logsDirectorySizeLimit: 35
            detailedErrorLoggingEnabled: false
            publishingUsername: "${{ self.sites_name }}"
            scmType: None
            use32BitWorkerProcess: false
            webSocketsEnabled: false
            alwaysOn: true
            managedPipelineMode: Integrated
            virtualApplications:
            - virtualPath: "/"
              physicalPath: site\wwwroot
              preloadEnabled: true
            loadBalancing: LeastRequests
            experiments:
              rampUpRules: []
            autoHealEnabled: false
            vnetRouteAllEnabled: false
            vnetPrivatePortsCount: 0
            publicNetworkAccess: Disabled
            localMySqlEnabled: false
            ipSecurityRestrictions:
            - ipAddress: Any
              action: Allow
              priority: 2147483647
              name: Allow all
              description: Allow all access
            scmIpSecurityRestrictions:
            - ipAddress: Any
              action: Allow
              priority: 2147483647
              name: Allow all
              description: Allow all access
            scmIpSecurityRestrictionsUseMain: false
            http20Enabled: true
            minTlsVersion: '1.2'
            scmMinTlsVersion: '1.2'
            ftpsState: Disabled
            preWarmedInstanceCount: 0
            elasticWebAppScaleLimit: 0
            functionsRuntimeScaleMonitoringEnabled: false
            minimumElasticInstanceCount: 0
            azureStorageAccounts: {}
        - type: Microsoft.Web/sites/hostNameBindings
          apiVersion: '2023-12-01'
          name: "[concat(parameters('sites_name'), '/', parameters('sites_name'),
            '.azurewebsites.net')]"
          location: West Europe
          dependsOn:
          - "[resourceId('Microsoft.Web/sites', parameters('sites_name'))]"
          properties:
            siteName: "{{ self.sites_name }}"
            hostNameType: Verified
        - type: Microsoft.Web/sites/privateEndpointConnections
          apiVersion: '2023-12-01'
          name: "[concat(parameters('sites_name'), '/', parameters('sites_name'),
            '-sites-psc-1e387e62-8806-43c6-b850-9b8c6b95d81f')]"
          location: West Europe
          dependsOn:
          - "[resourceId('Microsoft.Web/sites', parameters('sites_name'))]"
          properties:
            privateEndpoint: {}
            privateLinkServiceConnectionState:
              status: Approved
              actionsRequired: None
            ipAddresses:
            - 11.11.11.11
